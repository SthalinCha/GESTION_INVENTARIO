<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facturas - Ferretería Don Telmo</title>
  <link rel="stylesheet" href="facturas.css" />
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar" aria-label="Menú principal" id="sidebar">
    <h2>Don Telmo</h2>
    <a href="productos.html" id="link-productos" title="Productos">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h18v2H3V3zm0 6h18v2H3V9zm0 6h18v2H3v-2z"/></svg>
      Productos
    </a>
    <a href="clientes.html" id="link-clientes" title="Clientes">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.4c-3.4 0-10.1 1.7-10.1 5v2.4h20.3v-2.4c0-3.3-6.7-5-10.2-5z"/></svg>
      Clientes
    </a>
    <a href="facturas.html" id="link-facturas" class="active" aria-current="page" title="Facturas">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 2h12c1.1 0 2 .9 2 2v16c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2zm12 18V6H6v14h12z"/></svg>
      Facturas
    </a>
  </nav>

  <!-- Navbar superior -->
  <header class="navbar" role="banner">
    <button class="menu-toggle" aria-label="Mostrar / Ocultar menú" id="menu-toggle">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6h18M3 12h18M3 18h18" stroke="#2c3e50" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <nav role="navigation" aria-label="Navegación principal">
      <a href="productos.html" id="nav-productos" title="Productos">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h18v2H3V3zm0 6h18v2H3V9zm0 6h18v2H3v-2z"/></svg>
        Productos
      </a>
      <a href="clientes.html" id="nav-clientes" title="Clientes">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.4c-3.4 0-10.1 1.7-10.1 5v2.4h20.3v-2.4c0-3.3-6.7-5-10.2-5z"/></svg>
        Clientes
      </a>
      <a href="facturas.html" id="nav-facturas" class="active" aria-current="page" title="Facturas">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 2h12c1.1 0 2 .9 2 2v16c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2zm12 18V6H6v14h12z"/></svg>
        Facturas
      </a>
    </nav>
  </header>

  <main id="main-content">

    <button id="toggle-view" aria-pressed="false">Ver Facturas del Día</button>

    <!-- Formulario crear factura -->
    <section id="form-factura">
      <h2>Crear Nueva Factura</h2>

      <form id="formulario-cliente" onsubmit="return false;" autocomplete="off">
        <div>
          <label for="cedula">Cédula:</label>
          <input type="text" id="cedula" name="cedula" placeholder="Ingrese cédula" required />
          <button type="button" id="buscar-cliente">Buscar Cliente</button>
        </div>

        <div>
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" name="nombre" readonly />
        </div>

        <div>
          <label for="telefono">Teléfono:</label>
          <input type="text" id="telefono" name="telefono" readonly />
        </div>

        <div>
          <label for="direccion">Dirección:</label>
          <input type="text" id="direccion" name="direccion" readonly />
        </div>

        <div>
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" readonly />
        </div>

        <div>
          <label for="fecha">Fecha de emisión:</label>
          <input type="date" id="fecha" name="fecha" required />
        </div>

        <div>
          <label for="producto">Producto:</label>
          <select id="producto" name="producto" aria-label="Seleccione un producto">
            <option value="">-- Cargando productos... --</option>
          </select>
        </div>

        <div>
          <label for="cantidad">Cantidad:</label>
          <input type="number" id="cantidad" name="cantidad" min="1" value="1" />
        </div>

        <button type="button" id="btn-agregar-producto">Agregar Producto</button>
      </form>

      <table aria-label="Detalle de la factura">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-productos"></tbody>
      </table>

      <section aria-label="Totales de la factura">
        <div>
          <label>Subtotal:</label>
          <input type="text" id="subtotal" readonly value="$0.00" />
        </div>
        <div>
          <label>IVA (12%):</label>
          <input type="text" id="iva" readonly value="$0.00" />
        </div>
        <div>
          <label>Total:</label>
          <input type="text" id="total" readonly value="$0.00" />
        </div>
      </section>

      <button type="button" id="guardar-factura">Guardar Factura</button>
    </section>

    <!-- Lista de facturas -->
    <section id="vista-facturas" hidden>
      <h2>Facturas del Día</h2>
      <table aria-label="Lista de facturas">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-facturas"></tbody>
      </table>
    </section>

  </main>

  <!-- Modal genérico -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-content" tabindex="-1" style="display:none;">
    <div class="modal" role="document">
      <button class="modal-close-btn" aria-label="Cerrar">&times;</button>
      <div id="modal-content" class="modal-content" tabindex="0"></div>
    </div>
  </div>

  <script>
    // Variables DOM
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    const menuToggleBtn = document.getElementById('menu-toggle');

    // Toggle sidebar
    menuToggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
      mainContent.classList.toggle('expanded');
    });

    // Resalta links activos (según URL)
    function resaltarLinks() {
      const path = window.location.pathname.split('/').pop();
      const sidebarLinks = document.querySelectorAll('nav.sidebar a');
      const navbarLinks = document.querySelectorAll('header.navbar nav a');

      sidebarLinks.forEach(link => {
        if(link.getAttribute('href') === path) {
          link.classList.add('active');
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.remove('active');
          link.removeAttribute('aria-current');
        }
      });
      navbarLinks.forEach(link => {
        if(link.getAttribute('href') === path) {
          link.classList.add('active');
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.remove('active');
          link.removeAttribute('aria-current');
        }
      });
    }
    resaltarLinks();

    // Modal funcionalidad
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = modal.querySelector('.modal-close-btn');

    function mostrarModal(html) {
      modalContent.innerHTML = html;
      modal.style.display = 'flex';
      modalContent.focus();
    }
    function cerrarModal() {
      modal.style.display = 'none';
      modalContent.innerHTML = '';
    }
    modalCloseBtn.addEventListener('click', cerrarModal);
    modal.addEventListener('click', e => {
      if (e.target === modal) cerrarModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        cerrarModal();
      }
    });

    // Toggle vistas
    const btnToggle = document.getElementById('toggle-view');
    const formFactura = document.getElementById('form-factura');
    const vistaFacturas = document.getElementById('vista-facturas');

    btnToggle.addEventListener('click', () => {
      const isFormVisible = !formFactura.hasAttribute('hidden');
      if (isFormVisible) {
        formFactura.setAttribute('hidden', '');
        vistaFacturas.removeAttribute('hidden');
        btnToggle.textContent = 'Crear Nueva Factura';
        btnToggle.setAttribute('aria-pressed', 'true');
        cargarFacturas();
      } else {
        vistaFacturas.setAttribute('hidden', '');
        formFactura.removeAttribute('hidden');
        btnToggle.textContent = 'Ver Facturas del Día';
        btnToggle.setAttribute('aria-pressed', 'false');
      }
    });

    // Cargar productos para select
    async function cargarProductos() {
      const selectProducto = document.getElementById('producto');
      try {
        const res = await fetch('http://localhost:8000/productos/');
        if (!res.ok) throw new Error('Error cargando productos');
        const productos = await res.json();
        selectProducto.innerHTML = '<option value="">-- Seleccione un producto --</option>';
        productos.forEach(p => {
          const option = document.createElement('option');
          option.value = p.idProducto;
          option.textContent = p.nombreProducto;
          option.dataset.precio = p.precioProducto;
          selectProducto.appendChild(option);
        });
      } catch (e) {
        selectProducto.innerHTML = '<option value="">-- Error cargando productos --</option>';
        console.error(e);
      }
    }

    // Productos en la factura
    let productosFactura = [];

    // Renderizar productos en tabla
    function renderizarProductos() {
      const tbody = document.getElementById('tabla-productos');
      tbody.innerHTML = '';
      productosFactura.forEach((p, i) => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td data-label="Producto">${p.nombre}</td>
          <td data-label="Cantidad" style="text-align:center;">${p.cantidad}</td>
          <td data-label="Precio Unitario" style="text-align:right;">$${p.precio.toFixed(2)}</td>
          <td data-label="Subtotal" style="text-align:right;">$${(p.precio * p.cantidad).toFixed(2)}</td>
          <td data-label="Acciones" style="text-align:center;">
            <button type="button" class="btn-eliminar" aria-label="Eliminar producto ${p.nombre}" data-index="${i}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(fila);
      });
      tbody.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          productosFactura.splice(idx, 1);
          renderizarProductos();
          actualizarTotales();
        });
      });
      actualizarTotales();
    }

    // Actualizar totales
    function actualizarTotales() {
      const subtotal = productosFactura.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
      const iva = subtotal * 0.12;
      const total = subtotal + iva;
      document.getElementById('subtotal').value = `$${subtotal.toFixed(2)}`;
      document.getElementById('iva').value = `$${iva.toFixed(2)}`;
      document.getElementById('total').value = `$${total.toFixed(2)}`;
    }

    // Agregar producto al detalle
    document.getElementById('btn-agregar-producto').addEventListener('click', () => {
      const selectProducto = document.getElementById('producto');
      const cantidadInput = document.getElementById('cantidad');
      if (selectProducto.value === '') {
        mostrarModal('<p>Seleccione un producto</p>');
        return;
      }
      const nombre = selectProducto.options[selectProducto.selectedIndex].text;
      const precio = parseFloat(selectProducto.options[selectProducto.selectedIndex].dataset.precio);
      const cantidad = parseInt(cantidadInput.value);
      if (!cantidad || cantidad < 1) {
        mostrarModal('<p>Ingrese una cantidad válida</p>');
        return;
      }
      const idxExist = productosFactura.findIndex(p => p.nombre === nombre);
      if (idxExist >= 0) {
        productosFactura[idxExist].cantidad += cantidad;
      } else {
        productosFactura.push({ nombre, precio, cantidad });
      }
      renderizarProductos();
      cantidadInput.value = 1;
      selectProducto.selectedIndex = 0;
    });

    // Buscar cliente
    document.getElementById('buscar-cliente').addEventListener('click', async () => {
      const cedula = document.getElementById('cedula').value.trim();
      if (!cedula) {
        mostrarModal('<p>Por favor, ingrese la cédula</p>');
        return;
      }
      try {
        const res = await fetch(`http://localhost:8001/clientes/buscar?cedula=${encodeURIComponent(cedula)}`);
        if (!res.ok) throw new Error('Error buscando clientes');
        const clientes = await res.json();
        if (clientes.length === 0) {
          mostrarModal('<p>No se encontraron clientes con esa cédula</p>');
          ['nombre','telefono','direccion','email'].forEach(id => document.getElementById(id).value = '');
          return;
        }
        if (clientes.length === 1) {
          const cliente = clientes[0];
          document.getElementById('nombre').value = cliente.nombreCliente || cliente.nombre || "";
          document.getElementById('telefono').value = cliente.telefonoCliente || cliente.telefono || "";
          document.getElementById('direccion').value = cliente.direccionCliente || cliente.direccion || "";
          document.getElementById('email').value = cliente.correoCliente || cliente.email || "";
        } else {
          const listaClientes = clientes.map(c => `${c.cedula || c.id}: ${c.nombreCliente || c.nombre}`).join('<br>');
          mostrarModal(`<p>Se encontraron varios clientes:</p><p>${listaClientes}</p><p>Por favor refine la búsqueda.</p>`);
        }
      } catch (error) {
        mostrarModal(`<p>${error.message}</p>`);
      }
    });

    // Guardar factura (simulado)
    document.getElementById('guardar-factura').addEventListener('click', () => {
      if (productosFactura.length === 0) {
        mostrarModal("<p>Agregue al menos un producto para guardar la factura.</p>");
        return;
      }
      const cedula = document.getElementById('cedula').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const fecha = document.getElementById('fecha').value;
      if (!cedula || !nombre || !fecha) {
        mostrarModal("<p>Complete los datos del cliente y la fecha.</p>");
        return;
      }
      // Aquí iría la llamada POST para guardar la factura en backend
      mostrarModal(`<p>Factura guardada correctamente para cliente ${nombre}.</p>`);
      productosFactura = [];
      renderizarProductos();
      document.getElementById('formulario-cliente').reset();
      actualizarTotales();
    });

    // Cargar facturas del día (simulado)
    async function cargarFacturas() {
      const tbody = document.getElementById('tabla-facturas');
      tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
      try {
        const res = await fetch('http://localhost:8002/facturas/dia');
        if (!res.ok) throw new Error('Error cargando facturas');
        const facturas = await res.json();
        if (facturas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No hay facturas para hoy.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        facturas.forEach(f => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${f.idFactura}</td>
            <td>${f.nombreCliente || f.nombre}</td>
            <td>${new Date(f.fechaEmision).toLocaleDateString()}</td>
            <td style="text-align:right;">$${f.total.toFixed(2)}</td>
            <td style="text-align:center;">
              <button type="button" aria-label="Ver detalles factura ${f.idFactura}" data-id="${f.idFactura}" class="btn-ver-factura">Detalles</button>
            </td>
          `;
          tbody.appendChild(fila);
        });
        tbody.querySelectorAll('.btn-ver-factura').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            try {
              const res = await fetch(`http://localhost:8002/facturas/${id}`);
              if (!res.ok) throw new Error('Error cargando detalles');
              const detalles = await res.json();
              let html = `<h3>Factura #${id}</h3><ul>`;
              detalles.forEach(item => {
                html += `<li>${item.nombreProducto} - Cantidad: ${item.cantidad} - Precio: $${item.precioUnitario.toFixed(2)}</li>`;
              });
              html += '</ul>';
              mostrarModal(html);
            } catch (error) {
              mostrarModal(`<p>${error.message}</p>`);
            }
          });
        });
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="5">Error al cargar facturas</td></tr>`;
        console.error(error);
      }
    }

    // Al cargar la página, carga productos para el select y configura fecha actual
    window.addEventListener('DOMContentLoaded', () => {
      cargarProductos();
      const fechaInput = document.getElementById('fecha');
      fechaInput.valueAsDate = new Date();
    });

  </script>
</body>
</html>
